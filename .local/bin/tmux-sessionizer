#!/usr/bin/env bash

find_git_dirs() {
    fd "\.git$" "$@" --hidden --format {//}
}

find_dirs() {
    fd . "$@" --exact-depth=1 --type=d --format {.}
}

select_path() {
    local -a paths git_dirs tail_dirs
    paths+=("$HOME")
    readarray -t git_dirs < <( find_git_dirs "$HOME/personal" "$HOME/work" | sort )
    readarray -t tail_dirs < <( {
        echo "$HOME/.local/bin"
        find_dirs "$XDG_CONFIG_HOME"
        } | sort
    )
    paths+=( "${git_dirs[@]}" )
    paths+=( "${tail_dirs[@]}" )

    printf '%s\n' "${paths[@]}" | fzf --tmux 80% --scheme=path
}

fatal() {
    echo "$1" >&2
    exit 1
}

main() {
    local selected selected_name

    if [[ $# -eq 1 ]]; then
        selected="$1"
    else
        selected=$( select_path )
    fi

    [[ -z "$selected" ]] && exit 0

    if [[ ! -d "$selected" ]]; then
        fatal "'$selected' is not a directory" >&2
    fi

    selected_name="$( basename "$selected" | tr . _ )__$( sha256sum <<<"$selected" | cut -c1-6 )"

    if ! tmux has-session -t "$selected_name" 2>/dev/null; then
        tmux new-session -d -s "$selected_name" -c "$selected" || fatal 'tmux failed to start session'
    fi

    if [[ -n "$TMUX" ]]; then
        tmux switch-client -t "$selected_name"
    else
        tmux attach-session -t "$selected_name"
    fi
}

main "$@"
